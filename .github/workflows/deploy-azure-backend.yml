name: Deploy Backend to Azure App Service

on:
  push:
    branches: [main, production]
    paths: ['server/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_WEBAPP_NAME: attars-backend # Replace with your App Service name
  AZURE_RESOURCE_GROUP: Attars # Replace with your Resource Group name
  KEY_VAULT_NAME: attars-backend-kv # Replace with your Key Vault name
  NODE_VERSION: '24.x'
  WORKING_DIRECTORY: './server'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Azure Key Vault Secrets
        run: |
          echo "ðŸ” Updating Azure Key Vault with application secrets..."
          
          # A function to set a secret in Key Vault
          set_secret() {
            local secret_name=$1
            local secret_value=$2
            if [ -n "$secret_value" ]; then
              echo "Setting secret: $secret_name"
              az keyvault secret set --vault-name "${{ env.KEY_VAULT_NAME }}" --name "$secret_name" --value "$secret_value" > /dev/null
            else
              echo "Skipping empty secret: $secret_name"
            fi
          }

          # Loop through all secrets and set them in Key Vault
          # This approach is more maintainable than individual commands

          set_secret "DATABASE" "${{ secrets.DATABASE }}"
          set_secret "SECRET" "${{ secrets.SECRET }}"
          set_secret "CLIENT-URL" "${{ secrets.CLIENT_URL }}" # Dashes are allowed in KV names
          set_secret "RAZORPAY-KEY-ID" "${{ secrets.RAZORPAY_KEY_ID }}"
          set_secret "RAZORPAY-KEY-SECRET" "${{ secrets.RAZORPAY_KEY_SECRET }}"
          set_secret "BREVO-API-KEY" "${{ secrets.BREVO_API_KEY }}"
          set_secret "BREVO-SENDER-EMAIL" "${{ secrets.BREVO_SENDER_EMAIL }}"
          set_secret "MSG91-AUTH-KEY" "${{ secrets.MSG91_AUTH_KEY }}"
          set_secret "REDIS-URL" "${{ secrets.REDIS_URL }}"
          
          # Payment integration parameters
          set_secret "BRAINTREE-MERCHANT-ID" "${{ secrets.BRAINTREE_MERCHANT_ID }}"
          set_secret "BRAINTREE-PUBLIC-KEY" "${{ secrets.BRAINTREE_PUBLIC_KEY }}"
          set_secret "BRAINTREE-PRIVATE-KEY" "${{ secrets.BRAINTREE_PRIVATE_KEY }}"
          set_secret "RAZORPAY-WEBHOOK-SECRET" "${{ secrets.RAZORPAY_WEBHOOK_SECRET }}"
          
          # Shipping parameters
          set_secret "SHIPROCKET-EMAIL" "${{ secrets.SHIPROCKET_EMAIL }}"
          set_secret "SHIPROCKET-PASSWORD" "${{ secrets.SHIPROCKET_PASSWORD }}"
          set_secret "SHIPROCKET-TEST-MODE" "${{ secrets.SHIPROCKET_TEST_MODE }}"
          set_secret "PICKUP-PINCODE" "${{ secrets.PICKUP_PINCODE }}"
          set_secret "PICKUP-NAME" "${{ secrets.PICKUP_NAME }}"
          set_secret "PICKUP-PHONE" "${{ secrets.PICKUP_PHONE }}"
          
          # Email service parameters
          set_secret "EMAIL-SERVICE" "${{ secrets.EMAIL_SERVICE }}"
          set_secret "BREVO-SENDER-NAME" "${{ secrets.BREVO_SENDER_NAME }}"
          
          # OAuth parameters
          set_secret "GOOGLE-CLIENT-ID" "${{ secrets.GOOGLE_CLIENT_ID }}"
          set_secret "GOOGLE-CLIENT-SECRET" "${{ secrets.GOOGLE_CLIENT_SECRET }}"
          set_secret "FACEBOOK-APP-ID" "${{ secrets.FACEBOOK_APP_ID }}"
          set_secret "FACEBOOK-APP-SECRET" "${{ secrets.FACEBOOK_APP_SECRET }}"
          
          # SMS parameters
          set_secret "MSG91-SENDER-ID" "${{ secrets.MSG91_SENDER_ID }}"
          set_secret "MSG91-TEMPLATE-ID" "${{ secrets.MSG91_TEMPLATE_ID }}"
          set_secret "MSG91-ROUTE" "${{ secrets.MSG91_ROUTE }}"
          
          # Node.js environment and URLs
          set_secret "NODE-ENV" "${{ secrets.NODE_ENV }}"
          set_secret "PRODUCTION-BACKEND-URL" "${{ secrets.PRODUCTION_BACKEND_URL }}"
          set_secret "PRODUCTION-CLIENT-URL" "${{ secrets.PRODUCTION_CLIENT_URL }}"
          
          # Telegram parameters
          set_secret "TELEGRAM-NOTIFICATIONS-ENABLED" "${{ secrets.TELEGRAM_NOTIFICATIONS_ENABLED }}"
          set_secret "TELEGRAM-BOT-TOKEN" "${{ secrets.TELEGRAM_BOT_TOKEN }}"
          set_secret "TELEGRAM-ADMIN-CHAT-ID" "${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}"
          
          # COD bypass
          set_secret "COD-BYPASS-OTP" "${{ secrets.COD_BYPASS_OTP }}"
          
          # Cloudflare R2 parameters
          set_secret "USE-R2" "${{ secrets.USE_R2 }}"
          set_secret "R2-ACCOUNT-ID" "${{ secrets.R2_ACCOUNT_ID }}"
          set_secret "R2-ACCESS-KEY-ID" "${{ secrets.R2_ACCESS_KEY_ID }}"
          set_secret "R2-SECRET-ACCESS-KEY" "${{ secrets.R2_SECRET_ACCESS_KEY }}"
          set_secret "R2-BUCKET-NAME" "${{ secrets.R2_BUCKET_NAME }}"
          set_secret "R2-PUBLIC-URL" "${{ secrets.R2_PUBLIC_URL }}"
          
          # Facebook Catalog parameters
          set_secret "FACEBOOK-CATALOG-ID" "${{ secrets.FACEBOOK_CATALOG_ID }}"
          set_secret "FACEBOOK-ACCESS-TOKEN" "${{ secrets.FACEBOOK_ACCESS_TOKEN }}"

          echo "âœ… All secrets updated successfully in Azure Key Vault."

      - name: Configure App Service Settings with Key Vault References
        run: |
          echo "âš™ï¸ Configuring App Service settings to reference Key Vault secrets..."
          
          # Define the mapping from Key Vault secret names (dashes) to App Service setting names (underscores)
          declare -A secret_map
          secret_map["DATABASE"]="DATABASE"
          secret_map["SECRET"]="SECRET"
          secret_map["CLIENT-URL"]="CLIENT_URL"
          secret_map["RAZORPAY-KEY-ID"]="RAZORPAY_KEY_ID"
          secret_map["RAZORPAY-KEY-SECRET"]="RAZORPAY_KEY_SECRET"
          secret_map["BREVO-API-KEY"]="BREVO_API_KEY"
          secret_map["BREVO-SENDER-EMAIL"]="BREVO_SENDER_EMAIL"
          secret_map["MSG91-AUTH-KEY"]="MSG91_AUTH_KEY"
          secret_map["REDIS-URL"]="REDIS_URL"
          secret_map["BRAINTREE-MERCHANT-ID"]="BRAINTREE_MERCHANT_ID"
          secret_map["BRAINTREE-PUBLIC-KEY"]="BRAINTREE_PUBLIC_KEY"
          secret_map["BRAINTREE-PRIVATE-KEY"]="BRAINTREE_PRIVATE_KEY"
          secret_map["RAZORPAY-WEBHOOK-SECRET"]="RAZORPAY_WEBHOOK_SECRET"
          secret_map["SHIPROCKET-EMAIL"]="SHIPROCKET_EMAIL"
          secret_map["SHIPROCKET-PASSWORD"]="SHIPROCKET_PASSWORD"
          secret_map["SHIPROCKET-TEST-MODE"]="SHIPROCKET_TEST_MODE"
          secret_map["PICKUP-PINCODE"]="PICKUP_PINCODE"
          secret_map["PICKUP-NAME"]="PICKUP_NAME"
          secret_map["PICKUP-PHONE"]="PICKUP_PHONE"
          secret_map["EMAIL-SERVICE"]="EMAIL_SERVICE"
          secret_map["BREVO-SENDER-NAME"]="BREVO_SENDER_NAME"
          secret_map["GOOGLE-CLIENT-ID"]="GOOGLE_CLIENT_ID"
          secret_map["GOOGLE-CLIENT-SECRET"]="GOOGLE_CLIENT_SECRET"
          secret_map["FACEBOOK-APP-ID"]="FACEBOOK_APP_ID"
          secret_map["FACEBOOK-APP-SECRET"]="FACEBOOK_APP_SECRET"
          secret_map["MSG91-SENDER-ID"]="MSG91_SENDER_ID"
          secret_map["MSG91-TEMPLATE-ID"]="MSG91_TEMPLATE_ID"
          secret_map["MSG91-ROUTE"]="MSG91_ROUTE"
          secret_map["NODE-ENV"]="NODE_ENV"
          secret_map["PRODUCTION-BACKEND-URL"]="PRODUCTION_BACKEND_URL"
          secret_map["PRODUCTION-CLIENT-URL"]="PRODUCTION_CLIENT_URL"
          secret_map["TELEGRAM-NOTIFICATIONS-ENABLED"]="TELEGRAM_NOTIFICATIONS_ENABLED"
          secret_map["TELEGRAM-BOT-TOKEN"]="TELEGRAM_BOT_TOKEN"
          secret_map["TELEGRAM-ADMIN-CHAT-ID"]="TELEGRAM_ADMIN_CHAT_ID"
          secret_map["COD-BYPASS-OTP"]="COD_BYPASS_OTP"
          secret_map["USE-R2"]="USE_R2"
          secret_map["R2-ACCOUNT-ID"]="R2_ACCOUNT_ID"
          secret_map["R2-ACCESS-KEY-ID"]="R2_ACCESS_KEY_ID"
          secret_map["R2-SECRET-ACCESS-KEY"]="R2_SECRET_ACCESS_KEY"
          secret_map["R2-BUCKET-NAME"]="R2_BUCKET_NAME"
          secret_map["R2-PUBLIC-URL"]="R2_PUBLIC_URL"
          secret_map["FACEBOOK-CATALOG-ID"]="FACEBOOK_CATALOG_ID"
          secret_map["FACEBOOK-ACCESS-TOKEN"]="FACEBOOK_ACCESS_TOKEN"
          
          # Add WEBSITES_PORT as a direct App Setting, not from Key Vault
          echo "Setting WEBSITES_PORT to 8000..."
          az webapp config appsettings set \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --settings WEBSITES_PORT=8000 > /dev/null
          
          # Loop through the map and set App Service settings with Key Vault references
          for kv_secret_name in "${!secret_map[@]}"; do
            app_setting_name="${secret_map[$kv_secret_name]}"
            
            # Get the secret URI from Key Vault
            secret_uri=$(az keyvault secret show \
              --vault-name "${{ env.KEY_VAULT_NAME }}" \
              --name "$kv_secret_name" \
              --query "id" \
              --output tsv)
            
            if [ -n "$secret_uri" ]; then
              echo "Setting App Service setting: $app_setting_name with Key Vault reference for $kv_secret_name"
              az webapp config appsettings set \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --name ${{ env.AZURE_WEBAPP_NAME }} \
                --settings "$app_setting_name=@Microsoft.KeyVault(SecretUri=$secret_uri)" > /dev/null
            else
              echo "âš ï¸ Warning: Key Vault secret '$kv_secret_name' not found. Skipping App Service setting for '$app_setting_name'."
            fi
          done
          
          echo "âœ… App Service settings configured with Key Vault references."

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd ${{ env.WORKING_DIRECTORY }}
          npm install --production

      - name: Check for Staging Slot and Set Deployment Target
        id: set-target
        run: |
          slot_exists=$(az webapp deployment slot list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --query "[?name=='staging']" -o tsv)
          if [[ -n "$slot_exists" ]]; then
            echo "âœ… Staging slot found. Using zero-downtime deployment strategy."
            echo "target_slot=staging" >> $GITHUB_OUTPUT
            echo "swap_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Staging slot not found. Deploying directly to production (brief downtime will occur)."
            echo "target_slot=production" >> $GITHUB_OUTPUT
            echo "swap_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: ${{ steps.set-target.outputs.target_slot }}
          package: ${{ env.WORKING_DIRECTORY }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }} # Optional: for another auth method

      - name: Warm-up and Swap Slots (if applicable)
        if: steps.set-target.outputs.swap_enabled == 'true'
        run: |
          STAGING_URL="https://${{ env.AZURE_WEBAPP_NAME }}-staging.azurewebsites.net"
          echo "Warming up staging slot at $STAGING_URL/api/health"
          
          # Warm-up by hitting the health check endpoint
          curl --fail --retry 5 --retry-delay 30 "$STAGING_URL/api/health"
          
          echo "Swapping staging slot to production..."
          az webapp deployment slot swap --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AZURE_WEBAPP_NAME }} --slot staging --target-slot production
          
      - name: Validate Production Deployment
        run: |
          PRODUCTION_URL="https://$(az webapp show --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "defaultHostName" --output tsv)"
          echo "Validating production deployment at $PRODUCTION_URL"
          
          # Wait for the swap to complete and DNS to propagate
          sleep 60 
          
          # Final health check on the production URL
          curl --fail --retry 3 --retry-delay 20 "$PRODUCTION_URL/api/health"
          
          echo "âœ… Production deployment successful and healthy."

      - name: Logout from Azure
        if: always()
        run: |
          az logout
          az cache purge
          az account clear
