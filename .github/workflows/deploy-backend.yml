name: Deploy Backend to Render

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-backend.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ./server

      # - name: Run tests (if any)
      #   run: npm test --if-present
      #   working-directory: ./server

      - name: Deploy to Render
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "‚ùå RENDER_DEPLOY_HOOK_URL secret is not set"
            echo "Please add your Render deploy hook URL to GitHub repository secrets"
            echo "Go to: GitHub repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "Add secret: RENDER_DEPLOY_HOOK_URL"
            exit 1
          fi
          
          echo "üöÄ Triggering Render deployment..."
          response=$(curl -s -w "%{http_code}" -o /tmp/response.txt "$RENDER_DEPLOY_HOOK_URL")
          
          if [ "$response" -eq 200 ] || [ "$response" -eq 201 ]; then
            echo "‚úÖ Deployment triggered successfully"
            cat /tmp/response.txt
          else
            echo "‚ùå Deployment failed with HTTP status: $response"
            cat /tmp/response.txt
            exit 1
          fi
