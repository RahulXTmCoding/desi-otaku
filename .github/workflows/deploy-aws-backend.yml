name: Deploy Fashion Backend to AWS (SSH-Free)

on:
  push:
    branches: [main, production]
    paths: ['server/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Validate Required Secrets
        run: |
          echo "üîç Validating required secrets..."
          
          missing_secrets=()
          
          # Check core required secrets
          [ -z "${{ secrets.DATABASE }}" ] && missing_secrets+=("DATABASE")
          [ -z "${{ secrets.SECRET }}" ] && missing_secrets+=("SECRET")
          [ -z "${{ secrets.CLIENT_URL }}" ] && missing_secrets+=("CLIENT_URL")
          [ -z "${{ secrets.RAZORPAY_KEY_ID }}" ] && missing_secrets+=("RAZORPAY_KEY_ID")
          [ -z "${{ secrets.RAZORPAY_KEY_SECRET }}" ] && missing_secrets+=("RAZORPAY_KEY_SECRET")
          [ -z "${{ secrets.BREVO_API_KEY }}" ] && missing_secrets+=("BREVO_API_KEY")
          [ -z "${{ secrets.BREVO_SENDER_EMAIL }}" ] && missing_secrets+=("BREVO_SENDER_EMAIL")
          [ -z "${{ secrets.MSG91_AUTH_KEY }}" ] && missing_secrets+=("MSG91_AUTH_KEY")
          [ -z "${{ secrets.REDIS_URL }}" ] && missing_secrets+=("REDIS_URL")
          
          if [ ${#missing_secrets[@]} -ne 0 ]; then
            echo "‚ùå Missing required secrets:"
            printf '%s\n' "${missing_secrets[@]}"
            echo ""
            echo "üí° Add missing secrets in GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          echo "‚úÖ All required secrets validated"

      - name: Find Auto Scaling Group
        id: get-asg
        run: |
          ASG_NAME="fashion-backend-production-asg"
          echo "üîç Finding Auto Scaling Group: $ASG_NAME"
          
          # Check if ASG exists
          if ! aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names $ASG_NAME &>/dev/null; then
            echo "‚ùå Auto Scaling Group '$ASG_NAME' not found!"
            echo "üí° Run infrastructure setup first: ./aws/scripts/create-infrastructure.sh"
            exit 1
          fi
          
          # Get ASG details
          ASG_DETAILS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names $ASG_NAME \
            --query 'AutoScalingGroups[0].[MinSize,MaxSize,DesiredCapacity]' \
            --output text)
          
          MIN_SIZE=$(echo $ASG_DETAILS | cut -f1)
          MAX_SIZE=$(echo $ASG_DETAILS | cut -f2)
          DESIRED_CAPACITY=$(echo $ASG_DETAILS | cut -f3)
          
          echo "‚úÖ Found ASG: $ASG_NAME"
          echo "üìä Current capacity: Min=$MIN_SIZE, Max=$MAX_SIZE, Desired=$DESIRED_CAPACITY"
          
          echo "asg_name=$ASG_NAME" >> $GITHUB_OUTPUT
          echo "min_size=$MIN_SIZE" >> $GITHUB_OUTPUT
          echo "max_size=$MAX_SIZE" >> $GITHUB_OUTPUT
          echo "desired_capacity=$DESIRED_CAPACITY" >> $GITHUB_OUTPUT

      - name: Update Parameter Store Secrets
        run: |
          echo "üîê Updating Parameter Store with application secrets..."
          
          # Parameter Store path prefix
          PARAM_PREFIX="/fashion-backend/production"
          
          # Core application parameters
          echo "üìù Setting core parameters..."
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/DATABASE" \
            --value "${{ secrets.DATABASE }}" \
            --type "SecureString" \
            --overwrite
          
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/SECRET" \
            --value "${{ secrets.SECRET }}" \
            --type "SecureString" \
            --overwrite
          
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/CLIENT_URL" \
            --value "${{ secrets.CLIENT_URL }}" \
            --type "String" \
            --overwrite
          
          # Payment integration parameters
          echo "üí≥ Setting payment parameters..."
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/RAZORPAY_KEY_ID" \
            --value "${{ secrets.RAZORPAY_KEY_ID }}" \
            --type "SecureString" \
            --overwrite
          
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/RAZORPAY_KEY_SECRET" \
            --value "${{ secrets.RAZORPAY_KEY_SECRET }}" \
            --type "SecureString" \
            --overwrite
          
          # Optional payment parameters
          if [ -n "${{ secrets.RAZORPAY_WEBHOOK_SECRET }}" ]; then
            aws ssm put-parameter \
              --name "$PARAM_PREFIX/RAZORPAY_WEBHOOK_SECRET" \
              --value "${{ secrets.RAZORPAY_WEBHOOK_SECRET }}" \
              --type "SecureString" \
              --overwrite
          fi
          
          if [ -n "${{ secrets.BRAINTREE_MERCHANT_ID }}" ]; then
            aws ssm put-parameter \
              --name "$PARAM_PREFIX/BRAINTREE_MERCHANT_ID" \
              --value "${{ secrets.BRAINTREE_MERCHANT_ID }}" \
              --type "SecureString" \
              --overwrite
          fi
          
          # Email service parameters
          echo "üìß Setting email parameters..."
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/BREVO_API_KEY" \
            --value "${{ secrets.BREVO_API_KEY }}" \
            --type "SecureString" \
            --overwrite
          
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/BREVO_SENDER_EMAIL" \
            --value "${{ secrets.BREVO_SENDER_EMAIL }}" \
            --type "String" \
            --overwrite
          
          if [ -n "${{ secrets.BREVO_SENDER_NAME }}" ]; then
            aws ssm put-parameter \
              --name "$PARAM_PREFIX/BREVO_SENDER_NAME" \
              --value "${{ secrets.BREVO_SENDER_NAME }}" \
              --type "String" \
              --overwrite
          fi
          
          # SMS service parameters
          echo "üì± Setting SMS parameters..."
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/MSG91_AUTH_KEY" \
            --value "${{ secrets.MSG91_AUTH_KEY }}" \
            --type "SecureString" \
            --overwrite
          
          if [ -n "${{ secrets.MSG91_SENDER_ID }}" ]; then
            aws ssm put-parameter \
              --name "$PARAM_PREFIX/MSG91_SENDER_ID" \
              --value "${{ secrets.MSG91_SENDER_ID }}" \
              --type "String" \
              --overwrite
          fi
          
          # Redis and other services
          echo "üîÑ Setting service parameters..."
          aws ssm put-parameter \
            --name "$PARAM_PREFIX/REDIS_URL" \
            --value "${{ secrets.REDIS_URL }}" \
            --type "SecureString" \
            --overwrite
          
          # Optional OAuth parameters
          if [ -n "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
            aws ssm put-parameter \
              --name "$PARAM_PREFIX/GOOGLE_CLIENT_ID" \
              --value "${{ secrets.GOOGLE_CLIENT_ID }}" \
              --type "SecureString" \
              --overwrite
          fi
          
          if [ -n "${{ secrets.GOOGLE_CLIENT_SECRET }}" ]; then
            aws ssm put-parameter \
              --name "$PARAM_PREFIX/GOOGLE_CLIENT_SECRET" \
              --value "${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              --type "SecureString" \
              --overwrite
          fi
          
          echo "‚úÖ All parameters updated successfully in Parameter Store"

      - name: Refresh Auto Scaling Group Instances
        run: |
          echo "üîÑ Starting Auto Scaling Group instance refresh..."
          ASG_NAME="${{ steps.get-asg.outputs.asg_name }}"
          
          # Start instance refresh for zero-downtime deployment
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name $ASG_NAME \
            --preferences '{
              "MinHealthyPercentage": 50,
              "InstanceWarmup": 300,
              "CheckpointPercentages": [50, 100],
              "CheckpointDelay": 600
            }' \
            --query 'InstanceRefreshId' --output text)
          
          echo "üöÄ Instance refresh started with ID: $REFRESH_ID"
          echo "‚è≥ This will take several minutes for zero-downtime deployment..."
          
          # Monitor refresh progress
          echo "üìä Monitoring refresh progress..."
          START_TIME=$(date +%s)
          TIMEOUT=1800  # 30 minutes timeout
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED -gt $TIMEOUT ]; then
              echo "‚ùå Instance refresh timed out after 30 minutes"
              exit 1
            fi
            
            # Get refresh status
            REFRESH_STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name $ASG_NAME \
              --instance-refresh-ids $REFRESH_ID \
              --query 'InstanceRefreshes[0].[Status,PercentageComplete]' \
              --output text)
            
            STATUS=$(echo $REFRESH_STATUS | cut -f1)
            PERCENTAGE=$(echo $REFRESH_STATUS | cut -f2)
            
            echo "üîÑ Refresh status: $STATUS ($PERCENTAGE% complete)"
            
            case $STATUS in
              "Successful 100")
                echo "‚úÖ Instance refresh completed successfully!"
                break
                ;;
              "Failed"|"Cancelled")
                echo "‚ùå Instance refresh failed with status: $STATUS"
                
                # Get failure details
                FAILURE_REASON=$(aws autoscaling describe-instance-refreshes \
                  --auto-scaling-group-name $ASG_NAME \
                  --instance-refresh-ids $REFRESH_ID \
                  --query 'InstanceRefreshes[0].StatusReason' \
                  --output text)
                
                echo "üí° Failure reason: $FAILURE_REASON"
                exit 1
                ;;
              "InProgress"|"Pending")
                # Continue monitoring
                sleep 30
                ;;
              *)
                echo "‚ö†Ô∏è Unknown status: $STATUS"
                sleep 30
                ;;
            esac
          done

      - name: Validate Deployment Health
        run: |
          echo "üè• Validating deployment health..."
          
          # Get Load Balancer DNS
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names fashion-backend-production-alb \
            --query 'LoadBalancers[0].DNSName' --output text 2>/dev/null || echo "")
          
          if [ -n "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
            echo "üåê Testing Load Balancer: http://$ALB_DNS"
            
            # Wait for new instances to be ready
            echo "‚è≥ Waiting 60 seconds for new instances to be ready..."
            sleep 60
            
            # Test load balancer health endpoint
            MAX_ATTEMPTS=10
            for attempt in $(seq 1 $MAX_ATTEMPTS); do
              echo "üîç Health check attempt $attempt/$MAX_ATTEMPTS..."
              
              if curl -f -m 10 -s "http://$ALB_DNS/health" | jq -e '.status' &>/dev/null; then
                echo "‚úÖ Load Balancer health check passed!"
                
                # Get health response for verification
                HEALTH_RESPONSE=$(curl -s "http://$ALB_DNS/health")
                echo "üìä Health check response:"
                echo "$HEALTH_RESPONSE" | jq '.' 2>/dev/null || echo "$HEALTH_RESPONSE"
                
                # Verify it's the actual application, not just health check server
                if echo "$HEALTH_RESPONSE" | grep -q "fashion-backend"; then
                  echo "üéâ Fashion backend application is running!"
                  echo "üåü Deployment successful at: http://$ALB_DNS"
                  break
                else
                  echo "‚ö†Ô∏è Health check passed but application may not be fully deployed yet"
                  if [ $attempt -eq $MAX_ATTEMPTS ]; then
                    echo "‚ùå Application not fully deployed after $MAX_ATTEMPTS attempts"
                    exit 1
                  fi
                fi
              else
                if [ $attempt -eq $MAX_ATTEMPTS ]; then
                  echo "‚ùå Load Balancer health check failed after $MAX_ATTEMPTS attempts"
                  echo "üí° Check instance logs and Auto Scaling Group status"
                  exit 1
                else
                  echo "‚ö†Ô∏è Health check failed, retrying in 30 seconds..."
                  sleep 30
                fi
              fi
            done
          else
            echo "‚ö†Ô∏è Load Balancer not found, checking individual instances..."
            
            # Get current instances
            INSTANCES=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names fashion-backend-production-asg \
              --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].InstanceId' \
              --output text)
            
            if [ -z "$INSTANCES" ]; then
              echo "‚ùå No running instances found"
              exit 1
            fi
            
            echo "üîç Testing individual instances: $INSTANCES"
            
            # Test each instance
            for instance_id in $INSTANCES; do
              INSTANCE_IP=$(aws ec2 describe-instances \
                --instance-ids $instance_id \
                --query 'Reservations[0].Instances[0].PublicIpAddress' \
                --output text)
              
              if [ "$INSTANCE_IP" != "None" ] && [ -n "$INSTANCE_IP" ]; then
                echo "üåê Testing instance $instance_id at $INSTANCE_IP:8000"
                
                if curl -f -m 10 -s "http://$INSTANCE_IP:8000/health" &>/dev/null; then
                  echo "‚úÖ Instance $instance_id is healthy"
                else
                  echo "‚ùå Instance $instance_id failed health check"
                fi
              fi
            done
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "üéâ ‚úÖ SSH-FREE DEPLOYMENT SUCCESSFUL!"
            echo "=========================================="
            echo ""
            echo "üåê Your fashion e-commerce backend is live!"
            echo "üîß Modern deployment architecture:"
            echo "   ‚Ä¢ ‚úÖ No SSH keys required"
            echo "   ‚Ä¢ ‚úÖ Secure Parameter Store for secrets"
            echo "   ‚Ä¢ ‚úÖ Zero-downtime Auto Scaling Group refresh"
            echo "   ‚Ä¢ ‚úÖ ARM64 Graviton instances for cost optimization"
            echo "   ‚Ä¢ ‚úÖ Auto-deployment on instance startup"
            echo ""
            echo "üìà Infrastructure features:"
            echo "   ‚Ä¢ Load balanced across multiple AZs"
            echo "   ‚Ä¢ Auto scaling based on CPU utilization"
            echo "   ‚Ä¢ Health checks and automated recovery"
            echo "   ‚Ä¢ CloudWatch monitoring and logging"
            echo ""
            
            # Show access URLs
            ALB_DNS=$(aws elbv2 describe-load-balancers \
              --names fashion-backend-production-alb \
              --query 'LoadBalancers[0].DNSName' --output text 2>/dev/null || echo "")
            
            if [ -n "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
              echo "üåü Access your backend:"
              echo "   ‚Ä¢ API: http://$ALB_DNS"
              echo "   ‚Ä¢ Health: http://$ALB_DNS/health"
            fi
          else
            echo "‚ùå üö® DEPLOYMENT FAILED!"
            echo "=========================================="
            echo ""
            echo "üí° Common troubleshooting steps:"
            echo "‚Ä¢ Check GitHub Secrets are properly configured"
            echo "‚Ä¢ Verify infrastructure exists (run create-infrastructure.sh)"
            echo "‚Ä¢ Check Auto Scaling Group has healthy instances"
            echo "‚Ä¢ Review Parameter Store permissions"
            echo "‚Ä¢ Check CloudWatch logs for application errors"
            echo ""
            echo "üîß Debug commands:"
            echo "   aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names fashion-backend-production-asg"
            echo "   aws elbv2 describe-target-health --target-group-arn <target-group-arn>"
            echo "   aws ssm get-parameters-by-path --path '/fashion-backend/production'"
          fi
          echo "=========================================="
